<!DOCTYPE html>
<html>
<head>
  <title>Login</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="container mt-5">
<h2>Chatbot Inventory Platform</h2>

<select id="role" class="form-select mb-2" onchange="toggleVendor()">
  <option value="admin">Admin</option>
  <option value="vendor">Vendor</option>
  <option value="user">User</option>
</select>

<input id="vendorDomain" class="form-control mb-2 d-none" placeholder="Vendor Domain">
<input id="email" class="form-control mb-2" placeholder="Email">
<input id="password" type="password" class="form-control mb-2" placeholder="Password">

<button class="btn btn-primary w-100" onclick="login()">Login</button>

<script>
function toggleVendor() {
  vendorDomain.classList.toggle("d-none", role.value !== "vendor");
}

async function login() {
  let endpoint = role.value === "vendor"
    ? `/auth/vendor/${vendorDomain.value}/token`
    : `/auth/${role.value}/token`;

  const form = new URLSearchParams();
  form.append("username", email.value);
  form.append("password", password.value);

  try {
    const res = await fetch("http://127.0.0.1:9000" + endpoint, { method: "POST", body: form });
    if (!res.ok) throw new Error("Login failed");

    const data = await res.json();

    // Save access token and role
    localStorage.setItem("access_token", data.access_token);
    localStorage.setItem("role", role.value);

    // ------------------ NEW: Save user info for user login ------------------
    if (role.value === "user" && data.user) {
        localStorage.setItem("user", JSON.stringify({
            id: data.user.id,
            name: data.user.name,
            email: data.user.email
        }));
    }
    // ------------------ END CHANGE ------------------

    // If vendor, store vendor info for dashboard
    if (role.value === "vendor" && data.vendor) {
      localStorage.setItem("vendor", JSON.stringify({
          id: data.vendor.id,
          name: data.vendor.name
      }));
    }

    // Redirect to dashboard
    window.location.href = `/${role.value}/dashboard.html`;
  } catch (err) {
    console.error(err);
    alert("Login failed. Please check your credentials.");
  }
}

</script>
</body>
</html>
